<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Room Booking</title>
<style>
	th {
		width: 100px;
	}
	td {
  		width: 10%;
	}
</style>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script>
	var link = window.location.href.toString();
	var auth = link.substring(94, link.length);
	const typeNames = [];
	const numAvailRooms = [];
	const occupancies = [];
	var chosenOccup = [];
	var hotelID = link[71];
	var startDate = link.substring(73, 83);
	var endDate = link.substring(84, 94);
	var authPost = link.substring(100, link.length);
	
	function availableRooms(){
		$.ajax({
			url: link.substring(0, 94) + "/available-rooms" + auth,
	        dataType: "json",
	        success: function(r){
	        	var rid = 0;
	        	var list = r["availableRoomsInfo"];
	        	    	
	        	for(var i = 0; i < list.length; ++i){	      		
	        		var row = $("<tr>");
	        		row.append("<td>" + list[i]["typeName"] + "</td>");
	        		row.append("<td>" + list[i]["occupancy"] + "</td>");
	        		row.append("<td>" + list[i]["size"] + "</td>");
	        		row.append("<td>" + list[i]["initialPrice"] + "</td>");
	        		row.append("<td>" + list[i]["numberOfAvailableRooms"] + "</td>");	
	        		$("#info").append(row);
	        		
	        		$("#choosingRooms").append("<label for="+i.toString()+">"+list[i]["typeName"]+"</label>&emsp;");
	        		$("#choosingRooms").append('<input type="number" id='+"t"+i.toString()+' value="0" min="0" max='+list[i]["numberOfAvailableRooms"].toString()+' step="1"><br><br>');
	        		
	        		typeNames.push(list[i]["typeName"]);
	        		numAvailRooms.push(list[i]["numberOfAvailableRooms"]);
	        		occupancies.push(list[i]["occupancy"]);
	        		
	        		//console.log("t"+i.toString());
	        	}
	        }
		})
	}
	
	function checkRoomsNum(){
		var sum = 0;
		var test = 0;
		var occupSum = 0;
		var occupFact = document.querySelector("#numOfOccupants").value;
		if(occupFact == 0){
			$("#warning").html("You cannot make booking for 0 people");
			return false;
		}		
		for(var k = 0; k < typeNames.length; ++k){
			var id = "#t"+k.toString();
			var val = document.querySelector(id).value;
			chosenOccup.push(val);
			if(val > numAvailRooms[k]){
				$("#warning").html("Sorry, there is no "+val+" available "+typeNames[k]+" rooms.");
				chosenOccup.splice(0, chosenOccup.length);
				return false;
			}
			sum += val;
			test += '0';
			occupSum += occupancies[k] * val;
		}
		//console.log(chosenOccup);
		if(occupFact > occupSum){
			$("#warning").html("You cannot order rooms for only "+occupSum+" people in total, if number of occupants is "+occupFact+".");
			chosenOccup.splice(0, chosenOccup.length);
			return false;
		}else if(sum === test){
			$("#warning").html("Please, choose at least 1 room!");
			chosenOccup.splice(0, chosenOccup.length);
			return false;
		}else return true;
	}
	
	function toBook(x){
		$.post(link.substring(0, 94) + "/to-book" + auth, 
				{auth: authPost, hotelID: hotelID, startDate: startDate, endDate: endDate, roomTypeName: typeNames[x], numberOfRooms: chosenOccup[x]},
				function(){
					console.log("Sended to Back: "+typeNames[x]+" "+chosenOccup[x]);
				});
	};
	
	function bookAll(){
		for(var z = 0; z < typeNames.length; ++z){
			toBook(z);
		}
	}
	
	$(document).ready(function() {
		availableRooms();
		
		$('#bookFinal').click(function() {
			if(checkRoomsNum()){
				console.log("Success!");
				//console.log(hotelID + " " + startDate + " " + endDate);
				bookAll();
				//alert and redirecting to profilePage
				alert("Successful Booking. You will see your bookings in Profile");
				window.location.href = "http://localhost:8080/HotelChainManagementSystem/services/profile" + auth;
			}
		});
	})
</script>
</head>
<body>
<h2>
<a href="http://localhost:8080/HotelChainManagementSystem/">Hotel Chain Management System</a>
</h2>

<label for="numOfOccupants">Number Of Occupants:</label>
<input type="number" id="numOfOccupants" min="1" max="20" value="1" step="1"><br><br>

<form id="choosingRooms">
	<label for="rooms">Choose Rooms:</label><br>
</form>

<table id="info" align="right" border="1">
	<tr>
		<th>Room Type Name</th>
		<th>Occupancy</th>
		<th>Size(m^3)</th>
		<th>Initial Price($)</th>
		<th>Number of Available Rooms</th>
	</tr>
</table>

<h4 id="warning" style="color:red"></h4>
<button id="bookFinal" type="button">Book</button>
</body>
</html>